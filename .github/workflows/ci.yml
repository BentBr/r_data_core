name: CI

on:
  # Only run on PRs - merges to main/develop already passed CI on the PR
  pull_request:
    branches: [ main, develop ]
  # Allow other workflows to call this one (for release-please PRs)
  workflow_call:

jobs:
  backend-prepare:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust (nightly)
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly
          components: clippy,rustfmt

      - name: Show rustc version
        run: rustc -Vv

      - name: Cache cargo registry + build
        uses: swatinem/rust-cache@v2
        with:
          workspaces: .

      - name: Cache cargo bin directory
        id: cache-cargo-bin
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin
          key: ${{ runner.os }}-cargo-bin-${{ hashFiles('Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-bin-

      - name: Install cargo-audit
        run: |
          if ! command -v cargo-audit &> /dev/null; then
            cargo install cargo-audit --locked
          fi

      - name: Install sqlx-cli
        run: |
          if ! command -v sqlx &> /dev/null; then
            cargo install sqlx-cli --no-default-features --features postgres --locked
          fi

  backend-clippy:
    needs: backend-prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust (nightly)
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly
          components: clippy,rustfmt

      - name: Cache cargo registry + build
        uses: swatinem/rust-cache@v2
        with:
          workspaces: .

      - name: Cache cargo bin directory
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin
          key: ${{ runner.os }}-cargo-bin-${{ hashFiles('Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-bin-

      - name: Clippy (strict)
        env:
          SQLX_OFFLINE: true
        run: |
          cargo clippy --workspace --all-targets --all-features -- \
            -D clippy::all -D warnings -D clippy::pedantic -D clippy::nursery

  backend-format:
    needs: backend-prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust (nightly)
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly
          components: clippy,rustfmt

      - name: Cache cargo registry + build
        uses: swatinem/rust-cache@v2
        with:
          workspaces: .

      - name: Format check
        env:
          SQLX_OFFLINE: true
        run: cargo fmt --check --all

  backend-audit:
    needs: backend-prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust (nightly)
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly
          components: clippy,rustfmt

      - name: Cache cargo registry + build
        uses: swatinem/rust-cache@v2
        with:
          workspaces: .

      - name: Cache cargo bin directory
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin
          key: ${{ runner.os }}-cargo-bin-${{ hashFiles('Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-bin-

      - name: Install cargo-audit
        run: |
          if ! command -v cargo-audit &> /dev/null; then
            cargo install cargo-audit --locked
          fi

      - name: Security audit
        run: cargo audit

  backend-tests:
    needs: backend-prepare
    runs-on: ubuntu-latest
    # Note: Using docker run instead of services: block to support workflow_call (reusable workflows)
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start PostgreSQL
        run: |
          docker run -d --name postgres \
            -e POSTGRES_USER=postgres \
            -e POSTGRES_PASSWORD=postgres \
            -e POSTGRES_DB=rdata_test \
            -p 5432:5432 \
            postgres:18-alpine
          # Wait for postgres to be ready
          for i in {1..30}; do
            docker exec postgres pg_isready -U postgres && break
            echo "Waiting for postgres..."
            sleep 1
          done

      - name: Start Redis
        run: |
          docker run -d --name redis \
            -p 6379:6379 \
            redis:8-alpine
          # Wait for redis to be ready
          for i in {1..30}; do
            docker exec redis redis-cli ping && break
            echo "Waiting for redis..."
            sleep 1
          done

      - name: Install Rust (nightly)
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly
          components: clippy,rustfmt

      - name: Cache cargo registry + build
        uses: swatinem/rust-cache@v2
        with:
          workspaces: .

      - name: Cache cargo bin directory
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin
          key: ${{ runner.os }}-cargo-bin-${{ hashFiles('Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-bin-

      - name: Install sqlx-cli
        run: |
          if ! command -v sqlx &> /dev/null; then
            cargo install sqlx-cli --no-default-features --features postgres --locked
          fi

      - name: Run migrations
        env:
          DATABASE_URL: postgres://postgres:postgres@localhost:5432/rdata_test
        run: |
          sqlx migrate run

      - name: Run tests
        env:
          DATABASE_URL: postgres://postgres:postgres@localhost:5432/rdata_test
          REDIS_URL: redis://localhost:6379
        run: RUST_LOG=error cargo test --workspace

  backend-build:
    needs: backend-prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust (nightly)
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly
          components: clippy,rustfmt

      - name: Cache cargo registry + build
        uses: swatinem/rust-cache@v2
        with:
          workspaces: .

      - name: Build verification
        env:
          SQLX_OFFLINE: true
        run: cargo build --workspace --all-features

  frontend-prepare:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: fe/package-lock.json

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: fe/node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('fe/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: Install dependencies
        working-directory: fe
        run: npm ci

  frontend-lint:
    needs: frontend-prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: fe/package-lock.json

      - name: Cache node_modules
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: fe/node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('fe/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: Install dependencies
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        working-directory: fe
        run: npm ci

      - name: Lint
        working-directory: fe
        run: npm run lint

  frontend-tests:
    needs: frontend-prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: fe/package-lock.json

      - name: Cache node_modules
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: fe/node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('fe/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: Install dependencies
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        working-directory: fe
        run: npm ci

      - name: Run tests
        working-directory: fe
        run: npm run test

  frontend-audit:
    needs: frontend-prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: fe/package-lock.json

      - name: Cache node_modules
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: fe/node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('fe/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: Install dependencies
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        working-directory: fe
        run: npm ci

      - name: Security audit
        working-directory: fe
        run: npm audit --audit-level=moderate

  frontend-build:
    needs: frontend-prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: fe/package-lock.json

      - name: Cache node_modules
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: fe/node_modules
          key: ${{ runner.os }}-node-modules-sharp-${{ hashFiles('fe/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-sharp-

      - name: Install system dependencies for sharp
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y libvips-dev

      - name: Install dependencies
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        working-directory: fe
        run: npm ci

      - name: Build
        working-directory: fe
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: fe/dist
          retention-days: 7

  static-website-prepare:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: static-website/package-lock.json

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: static-website/node_modules
          key: ${{ runner.os }}-static-website-node-modules-${{ hashFiles('static-website/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-static-website-node-modules-

      - name: Install dependencies
        working-directory: static-website
        run: npm ci

  static-website-lint:
    needs: static-website-prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: static-website/package-lock.json

      - name: Cache node_modules
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: static-website/node_modules
          key: ${{ runner.os }}-static-website-node-modules-${{ hashFiles('static-website/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-static-website-node-modules-

      - name: Install dependencies
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        working-directory: static-website
        run: npm ci

      - name: Lint
        working-directory: static-website
        run: npm run lint

  static-website-build:
    needs: static-website-prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: static-website/package-lock.json

      - name: Cache node_modules
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: static-website/node_modules
          key: ${{ runner.os }}-static-website-node-modules-sharp-${{ hashFiles('static-website/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-static-website-node-modules-sharp-

      - name: Install system dependencies for sharp
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y libvips-dev

      - name: Install dependencies
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        working-directory: static-website
        run: npm ci

      - name: Build
        working-directory: static-website
        env:
          VITE_BASE_URL: https://rdatacore.eu
          VITE_SITE_NAME: RDataCore
          VITE_R_DATA_CORE_DEMO_URL: https://demo.rdatacore.eu
          VITE_API_DOCS_URL: https://rdatacore.eu/api/docs/
          VITE_ADMIN_API_DOCS_URL: https://rdatacore.eu/admin/api/docs/
          VITE_GITHUB_RELEASES_URL: https://github.com/${{ github.repository }}/releases/latest
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: static-website-dist
          path: static-website/dist
          retention-days: 7

  static-website-test:
    needs: static-website-prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: static-website/package-lock.json

      - name: Cache node_modules
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: static-website/node_modules
          key: ${{ runner.os }}-static-website-node-modules-${{ hashFiles('static-website/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-static-website-node-modules-

      - name: Install dependencies
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        working-directory: static-website
        run: npm ci

      - name: Run tests
        working-directory: static-website
        run: npm run test

  static-website-audit:
    needs: static-website-prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: static-website/package-lock.json

      - name: Cache node_modules
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: static-website/node_modules
          key: ${{ runner.os }}-static-website-node-modules-${{ hashFiles('static-website/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-static-website-node-modules-

      - name: Install dependencies
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        working-directory: static-website
        run: npm ci

      - name: Security audit
        working-directory: static-website
        run: npm audit --audit-level=moderate

  ci-gate:
    needs:
      - backend-clippy
      - backend-format
      - backend-audit
      - backend-tests
      - backend-build
      - frontend-lint
      - frontend-tests
      - frontend-audit
      - frontend-build
      - static-website-lint
      - static-website-test
      - static-website-build
      - static-website-audit
    runs-on: ubuntu-latest
    steps:
      - name: All checks passed
        run: echo "All CI checks have passed successfully"
