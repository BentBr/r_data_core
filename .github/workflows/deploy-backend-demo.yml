# ==============================================================================
# Deploy Backend to Demo Server
# ==============================================================================
# ‚ö†Ô∏è  WARNING: This is a DEMO deployment workflow, NOT for production use.
# True production deployments should use native Kubernetes (k8s).
# ==============================================================================
# This workflow deploys the backend services (core, worker, maintenance) to
# the demo server via SSH.
# ==============================================================================

name: Deploy Backend to Demo Server

on:
    workflow_dispatch:
        inputs:
            server_host:
                description: 'Demo server hostname or IP'
                required: true
                type: string
            server_user:
                description: 'SSH user for demo server'
                required: true
                default: 'root'
                type: string
            compose_file_path:
                description: 'Path to docker-compose.demo.yml on server'
                required: true
                default: '/opt/r-data-core-demo/docker-compose.demo.yml'
                type: string

env:
    REGISTRY: ghcr.io

jobs:
    deploy:
        runs-on: ubuntu-latest
        permissions:
            contents: read

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set lowercase repo owner
              id: repo
              run: echo "owner_lc=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_OUTPUT

            - name: Deploy backend services to demo server
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ inputs.server_host }}
                  username: ${{ inputs.server_user }}
                  key: ${{ secrets.DEMO_SERVER_SSH_KEY }}
                  port: 22
                  script: |
                      set -euo pipefail
                      
                      echo "=============================================================================="
                      echo "‚ö†Ô∏è  DEMO BACKEND DEPLOYMENT - NOT FOR PRODUCTION"
                      echo "=============================================================================="
                      echo ""
                      
                      COMPOSE_FILE="${{ inputs.compose_file_path }}"
                      OWNER_LC="${{ steps.repo.outputs.owner_lc }}"
                      
                      # Check if compose file exists
                      if [ ! -f "$COMPOSE_FILE" ]; then
                          echo "‚ùå Error: Compose file not found at $COMPOSE_FILE"
                          exit 1
                      fi
                      
                      # Login to GHCR if needed
                      echo "üîê Logging in to GitHub Container Registry..."
                      echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin || true
                      
                      # Pull latest images
                      echo ""
                      echo "üì• Pulling latest backend images..."
                      export GITHUB_REPO_OWNER="$OWNER_LC"
                      docker compose -f "$COMPOSE_FILE" pull core worker maintenance || {
                          echo "‚ö†Ô∏è  Warning: Failed to pull some images. Continuing..."
                      }
                      
                      # Restart services
                      echo ""
                      echo "üîÑ Restarting backend services..."
                      export GITHUB_REPO_OWNER="$OWNER_LC"
                      docker compose -f "$COMPOSE_FILE" up -d core worker maintenance
                      
                      # Wait for health checks
                      echo ""
                      echo "‚è≥ Waiting for services to be healthy..."
                      sleep 10
                      
                      # Check service status
                      echo ""
                      echo "üìä Service status:"
                      docker compose -f "$COMPOSE_FILE" ps core worker maintenance
                      
                      echo ""
                      echo "‚úÖ Backend deployment complete!"
                      echo ""
                      echo "‚ö†Ô∏è  Remember: This is a DEMO setup, not production!"

