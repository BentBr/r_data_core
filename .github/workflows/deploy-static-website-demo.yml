# ==============================================================================
# Deploy Static Website to Demo Server
# ==============================================================================
# ‚ö†Ô∏è  WARNING: This is a DEMO deployment workflow, NOT for production use.
# True production deployments should use native Kubernetes (k8s).
# ==============================================================================
# This workflow deploys the static website to the demo server via SSH.
# Note: Static website may need to be built on the server if no image is available.
# ==============================================================================

name: Deploy Static Website to Demo Server

on:
    workflow_dispatch:
        inputs:
            server_host:
                description: 'Demo server hostname or IP'
                required: true
                type: string
            server_user:
                description: 'SSH user for demo server'
                required: true
                default: 'root'
                type: string
            compose_file_path:
                description: 'Path to docker-compose.demo.yml on server'
                required: true
                default: '/opt/r-data-core-demo/docker-compose.demo.yml'
                type: string

env:
    REGISTRY: ghcr.io

jobs:
    deploy:
        runs-on: ubuntu-latest
        permissions:
            contents: read

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set lowercase repo owner
              id: repo
              run: echo "owner_lc=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_OUTPUT

            - name: Deploy static website to demo server
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ inputs.server_host }}
                  username: ${{ inputs.server_user }}
                  key: ${{ secrets.DEMO_SERVER_SSH_KEY }}
                  port: 22
                  script: |
                      set -euo pipefail
                      
                      echo "=============================================================================="
                      echo "‚ö†Ô∏è  DEMO STATIC WEBSITE DEPLOYMENT - NOT FOR PRODUCTION"
                      echo "=============================================================================="
                      echo ""
                      
                      COMPOSE_FILE="${{ inputs.compose_file_path }}"
                      OWNER_LC="${{ steps.repo.outputs.owner_lc }}"
                      
                      # Check if compose file exists
                      if [ ! -f "$COMPOSE_FILE" ]; then
                          echo "‚ùå Error: Compose file not found at $COMPOSE_FILE"
                          exit 1
                      fi
                      
                      echo ""
                      echo "üì• Pulling static website image (public repo, no login needed)..."
                      export GITHUB_REPO_OWNER="$OWNER_LC"
                      docker compose -f "$COMPOSE_FILE" pull static-website || {
                          echo "‚ùå Error: Failed to pull static-website image"
                          echo "   The static website image may not be published yet."
                          echo "   Build and publish the image first, or uncomment the build section in docker-compose.demo.yml"
                          exit 1
                      }
                      
                      # Restart service
                      echo ""
                      echo "üîÑ Restarting static website service..."
                      export GITHUB_REPO_OWNER="$OWNER_LC"
                      docker compose -f "$COMPOSE_FILE" up -d static-website
                      
                      # Wait for health check
                      echo ""
                      echo "‚è≥ Waiting for service to be healthy..."
                      sleep 10
                      
                      # Check service status
                      echo ""
                      echo "üìä Service status:"
                      docker compose -f "$COMPOSE_FILE" ps static-website
                      
                      # Test endpoint
                      echo ""
                      echo "üß™ Testing endpoint..."
                      if curl -f -s http://localhost:8080/health > /dev/null 2>&1; then
                          echo "‚úÖ Health check passed"
                      else
                          echo "‚ö†Ô∏è  Warning: Health check failed (service may still be starting)"
                      fi
                      
                      echo ""
                      echo "‚úÖ Static website deployment complete!"
                      echo ""
                      echo "‚ö†Ô∏è  Remember: This is a DEMO setup, not production!"

